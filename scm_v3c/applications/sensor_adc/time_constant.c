#include "time_constant.h"

#include <math.h>
#include <stdbool.h>
#include <stdint.h>
#include <stdlib.h>

#include "adc_msb.h"

// Maximum number of ADC samples.
#define TIME_CONSTANT_MAX_NUM_ADC_SAMPLES 5000

// Maximum number of samples since the minimum ADC sample to determine whether
// sufficient ADC samples have been received.
#define TIME_CONSTANT_MAX_NUM_SAMPLES_SINCE_MINIMUM 100

// Number of samples to average at the end to find the minimum ADC sample.
#define TIME_CONSTANT_NUM_AVERAGES_FOR_MIN_ADC_SAMPLE 10

// Empirical ADC standard deviation in LSBs.
#define TIME_CONSTANT_ADC_STDDEV 5

// Time constant analysis state enum.
typedef enum {
    TIME_CONSTANT_STATE_INVALID = -1,
    TIME_CONSTANT_STATE_IDLE = 0,
    TIME_CONSTANT_STATE_RECEIVING = 1,
    TIME_CONSTANT_STATE_HAS_SUFFICIENT_SAMPLES = 2,
    TIME_CONSTANT_STATE_DONE = 3,
} time_constant_state_t;

// Time constant state.
static time_constant_state_t g_time_constant_state =
    TIME_CONSTANT_STATE_INVALID;

// Number of ADC samples in the buffer.
static size_t g_time_constant_num_adc_samples = 0;

// Buffer for the ADC samples.
static uint16_t g_time_constant_adc_samples[TIME_CONSTANT_MAX_NUM_ADC_SAMPLES];

// Minimum ADC sample in the buffer.
static uint16_t g_time_constant_min_adc_sample = ADC_MAX_THEORETICAL_ADC_SAMPLE;

// Number of samples since the minimum ADC sample was updated.
static size_t g_time_constant_num_samples_since_minimum = 0;

// Natural logarithm lookup table.
static float g_time_constant_ln_lookup_table[] = {
    0.0,      0.0,      0.693147, 1.098612, 1.386294, 1.609437, 1.791759,
    1.945910, 2.079441, 2.197224, 2.302585, 2.397895, 2.484906, 2.564949,
    2.639057, 2.708050, 2.772588, 2.833213, 2.890371, 2.944438, 2.995732,
    3.044522, 3.091042, 3.135494, 3.178053, 3.218875, 3.258096, 3.295836,
    3.332204, 3.367295, 3.401197, 3.433987, 3.465735, 3.496507, 3.526360,
    3.555348, 3.583518, 3.610917, 3.637586, 3.663561, 3.688879, 3.713572,
    3.737669, 3.761200, 3.784189, 3.806662, 3.828641, 3.850147, 3.871201,
    3.891820, 3.912023, 3.931825, 3.951243, 3.970291, 3.988984, 4.007333,
    4.025351, 4.043051, 4.060443, 4.077537, 4.094344, 4.110873, 4.127134,
    4.143134, 4.158883, 4.174387, 4.189654, 4.204692, 4.219507, 4.234106,
    4.248495, 4.262679, 4.276666, 4.290459, 4.304065, 4.317488, 4.330733,
    4.343805, 4.356708, 4.369447, 4.382026, 4.394449, 4.406719, 4.418840,
    4.430816, 4.442651, 4.454347, 4.465908, 4.477336, 4.488636, 4.499809,
    4.510859, 4.521788, 4.532599, 4.543294, 4.553876, 4.564348, 4.574710,
    4.584967, 4.595119, 4.605170, 4.615120, 4.624972, 4.634728, 4.644390,
    4.653960, 4.663439, 4.672828, 4.682131, 4.691347, 4.700480, 4.709530,
    4.718498, 4.727387, 4.736198, 4.744932, 4.753590, 4.762173, 4.770684,
    4.779123, 4.787491, 4.795790, 4.804021, 4.812184, 4.820281, 4.828313,
    4.836281, 4.844187, 4.852030, 4.859812, 4.867534, 4.875197, 4.882801,
    4.890349, 4.897839, 4.905274, 4.912654, 4.919980, 4.927253, 4.934473,
    4.941642, 4.948759, 4.955827, 4.962844, 4.969813, 4.976733, 4.983606,
    4.990432, 4.997212, 5.003946, 5.010635, 5.017279, 5.023880, 5.030437,
    5.036952, 5.043425, 5.049856, 5.056245, 5.062595, 5.068904, 5.075173,
    5.081404, 5.087596, 5.093750, 5.099866, 5.105945, 5.111987, 5.117993,
    5.123963, 5.129898, 5.135798, 5.141663, 5.147494, 5.153291, 5.159055,
    5.164785, 5.170483, 5.176149, 5.181783, 5.187385, 5.192956, 5.198497,
    5.204006, 5.209486, 5.214935, 5.220355, 5.225746, 5.231108, 5.236441,
    5.241747, 5.247024, 5.252273, 5.257495, 5.262690, 5.267858, 5.272999,
    5.278114, 5.283203, 5.288267, 5.293304, 5.298317, 5.303304, 5.308267,
    5.313205, 5.318119, 5.323009, 5.327876, 5.332718, 5.337538, 5.342334,
    5.347107, 5.351858, 5.356586, 5.361292, 5.365976, 5.370638, 5.375278,
    5.379897, 5.384495, 5.389071, 5.393627, 5.398162, 5.402677, 5.407171,
    5.411646, 5.416100, 5.420534, 5.424950, 5.429345, 5.433722, 5.438079,
    5.442417, 5.446737, 5.451038, 5.455321, 5.459585, 5.463831, 5.468060,
    5.472270, 5.476463, 5.480638, 5.484796, 5.488937, 5.493061, 5.497168,
    5.501258, 5.505331, 5.509388, 5.513428, 5.517452, 5.521460, 5.525452,
    5.529429, 5.533389, 5.537334, 5.541263, 5.545177, 5.549076, 5.552959,
    5.556828, 5.560681, 5.564520, 5.568344, 5.572154, 5.575949, 5.579729,
    5.583496, 5.587248, 5.590986, 5.594711, 5.598421, 5.602118, 5.605802,
    5.609471, 5.613128, 5.616771, 5.620400, 5.624017, 5.627621, 5.631211,
    5.634789, 5.638354, 5.641907, 5.645446, 5.648974, 5.652489, 5.655991,
    5.659482, 5.662960, 5.666426, 5.669880, 5.673323, 5.676753, 5.680172,
    5.683579, 5.686975, 5.690359, 5.693732, 5.697093, 5.700443, 5.703782,
    5.707110, 5.710427, 5.713732, 5.717027, 5.720311, 5.723585, 5.726847,
    5.730099, 5.733341, 5.736572, 5.739792, 5.743003, 5.746203, 5.749392,
    5.752572, 5.755742, 5.758901, 5.762051, 5.765191, 5.768320, 5.771441,
    5.774551, 5.777652, 5.780743, 5.783825, 5.786897, 5.789960, 5.793013,
    5.796057, 5.799092, 5.802118, 5.805134, 5.808142, 5.811140, 5.814130,
    5.817111, 5.820082, 5.823045, 5.826000, 5.828945, 5.831882, 5.834810,
    5.837730, 5.840641, 5.843544, 5.846438, 5.849324, 5.852202, 5.855071,
    5.857933, 5.860786, 5.863631, 5.866468, 5.869296, 5.872117, 5.874930,
    5.877735, 5.880532, 5.883322, 5.886104, 5.888877, 5.891644, 5.894402,
    5.897153, 5.899897, 5.902633, 5.905361, 5.908082, 5.910796, 5.913503,
    5.916202, 5.918893, 5.921578, 5.924255, 5.926926, 5.929589, 5.932245,
    5.934894, 5.937536, 5.940171, 5.942799, 5.945420, 5.948034, 5.950642,
    5.953243, 5.955837, 5.958424, 5.961005, 5.963579, 5.966146, 5.968707,
    5.971261, 5.973809, 5.976350, 5.978885, 5.981414, 5.983936, 5.986452,
    5.988961, 5.991464, 5.993961, 5.996452, 5.998936, 6.001414, 6.003887,
    6.006353, 6.008813, 6.011267, 6.013715, 6.016157, 6.018593, 6.021023,
    6.023447, 6.025865, 6.028278, 6.030685, 6.033086, 6.035481, 6.037870,
    6.040254, 6.042632, 6.045005, 6.047372, 6.049733, 6.052089, 6.054439,
    6.056784, 6.059123, 6.061456, 6.063785, 6.066108, 6.068425, 6.070737,
    6.073044, 6.075346, 6.077642, 6.079933, 6.082218, 6.084499, 6.086774,
    6.089044, 6.091309, 6.093569, 6.095824, 6.098074, 6.100318, 6.102558,
    6.104793, 6.107022, 6.109247, 6.111467, 6.113682, 6.115892, 6.118097,
    6.120297, 6.122492, 6.124683, 6.126869, 6.129050, 6.131226, 6.133398,
    6.135564, 6.137727, 6.139884, 6.142037, 6.144185, 6.146329, 6.148468,
    6.150602, 6.152732, 6.154858, 6.156978, 6.159095, 6.161207, 6.163314,
    6.165417, 6.167516, 6.169610, 6.171700, 6.173786, 6.175867, 6.177944,
    6.180016, 6.182084, 6.184148, 6.186208, 6.188264, 6.190315, 6.192362,
    6.194405, 6.196444, 6.198478, 6.200509, 6.202535, 6.204557, 6.206575,
    6.208590, 6.210600, 6.212606, 6.214608, 6.216606, 6.218600, 6.220590,
    6.222576, 6.224558, 6.226536, 6.228511, 6.230481, 6.232448, 6.234410,
    6.236369, 6.238324, 6.240275, 6.242223, 6.244166, 6.246106, 6.248042,
    6.249975, 6.251903, 6.253828, 6.255750, 6.257667, 6.259581, 6.261491,
    6.263398, 6.265301, 6.267200, 6.269096, 6.270988, 6.272877, 6.274762,
    6.276643, 6.278521, 6.280395, 6.282266, 6.284134, 6.285998, 6.287858,
    6.289715, 6.291569, 6.293419, 6.295266, 6.297109, 6.298949, 6.300785,
    6.302618, 6.304448, 6.306275, 6.308098, 6.309918, 6.311734, 6.313548,
    6.315358, 6.317164, 6.318968, 6.320768, 6.322565, 6.324358, 6.326149,
    6.327936, 6.329720, 6.331501, 6.333279, 6.335054, 6.336825, 6.338594,
    6.340359, 6.342121, 6.343880, 6.345636, 6.347389, 6.349138, 6.350885,
    6.352629, 6.354370, 6.356107, 6.357842, 6.359573, 6.361302, 6.363028,
    6.364750, 6.366470, 6.368187, 6.369900, 6.371611, 6.373319, 6.375024,
    6.376726, 6.378426, 6.380122, 6.381816, 6.383506, 6.385194, 6.386879,
    6.388561, 6.390240, 6.391917, 6.393590, 6.395261, 6.396929, 6.398594,
    6.400257, 6.401917, 6.403574, 6.405228, 6.406879, 6.408528, 6.410174,
    6.411818, 6.413458, 6.415096, 6.416732, 6.418364, 6.419994, 6.421622,
    6.423246, 6.424869, 6.426488, 6.428105, 6.429719, 6.431331, 6.432940,
    6.434546, 6.436150, 6.437751, 6.439350, 6.440946, 6.442540, 6.444131,
    6.445719, 6.447305, 6.448889, 6.450470, 6.452048, 6.453624, 6.455198,
    6.456769, 6.458338, 6.459904, 6.461468, 6.463029, 6.464588, 6.466144,
    6.467698, 6.469250, 6.470799, 6.472346, 6.473890, 6.475432, 6.476972,
    6.478509, 6.480044, 6.481577, 6.483107, 6.484635, 6.486160, 6.487684,
    6.489204, 6.490723, 6.492239, 6.493753, 6.495265, 6.496774, 6.498282,
    6.499787, 6.501289, 6.502790, 6.504288, 6.505784, 6.507277, 6.508769,
    6.510258, 6.511745, 6.513230, 6.514712, 6.516193, 6.517671, 6.519147,
    6.520621, 6.522092, 6.523562, 6.525029, 6.526494, 6.527957, 6.529418,
    6.530877, 6.532334, 6.533788, 6.535241, 6.536691, 6.538139, 6.539585,
    6.541029, 6.542471, 6.543911, 6.545349, 6.546785, 6.548219, 6.549650,
    6.551080, 6.552507, 6.553933, 6.555356, 6.556778, 6.558197, 6.559615,
    6.561030, 6.562444, 6.563855, 6.565264, 6.566672, 6.568077, 6.569481,
    6.570882, 6.572282, 6.573680, 6.575075, 6.576469, 6.577861, 6.579251,
    6.580639, 6.582025, 6.583409, 6.584791, 6.586171, 6.587550, 6.588926,
    6.590301, 6.591673, 6.593044, 6.594413, 6.595780, 6.597145, 6.598509,
    6.599870, 6.601230, 6.602587, 6.603943, 6.605297, 6.606650, 6.608000,
    6.609349, 6.610696, 6.612041, 6.613384, 6.614725, 6.616065, 6.617402,
    6.618738, 6.620073, 6.621405, 6.622736, 6.624065, 6.625392, 6.626717,
    6.628041, 6.629363, 6.630683, 6.632001, 6.633318, 6.634633, 6.635946,
    6.637258, 6.638567, 6.639875, 6.641182, 6.642486, 6.643789, 6.645090,
    6.646390, 6.647688, 6.648984, 6.650279, 6.651571, 6.652863, 6.654152,
    6.655440, 6.656726, 6.658011, 6.659293, 6.660575, 6.661854, 6.663132,
    6.664409, 6.665683, 6.666956, 6.668228, 6.669498, 6.670766, 6.672032,
    6.673297, 6.674561, 6.675823, 6.677083, 6.678342, 6.679599, 6.680854,
    6.682108, 6.683360, 6.684611, 6.685860, 6.687108, 6.688354, 6.689599,
    6.690842, 6.692083, 6.693323, 6.694562, 6.695798, 6.697034, 6.698268,
    6.699500, 6.700731, 6.701960, 6.703188, 6.704414, 6.705639, 6.706862,
    6.708084, 6.709304, 6.710523, 6.711740, 6.712956, 6.714170, 6.715383,
    6.716594, 6.717804, 6.719013, 6.720220, 6.721425, 6.722629, 6.723832,
    6.725033, 6.726233, 6.727431, 6.728628, 6.729824, 6.731018, 6.732210,
    6.733401, 6.734591, 6.735780, 6.736966, 6.738152, 6.739336, 6.740519,
    6.741700, 6.742880, 6.744059, 6.745236, 6.746412, 6.747586, 6.748759,
    6.749931, 6.751101, 6.752270, 6.753437, 6.754604, 6.755768, 6.756932,
    6.758094, 6.759255, 6.760414, 6.761572, 6.762729, 6.763884, 6.765038,
    6.766191, 6.767343, 6.768493, 6.769641, 6.770789, 6.771935, 6.773080,
    6.774223, 6.775366, 6.776506, 6.777646, 6.778784, 6.779921, 6.781057,
    6.782192, 6.783325, 6.784457, 6.785587, 6.786716, 6.787844, 6.788971,
    6.790097, 6.791221, 6.792344, 6.793466, 6.794586, 6.795705, 6.796823,
    6.797940, 6.799055, 6.800170, 6.801283, 6.802394, 6.803505, 6.804614,
    6.805722, 6.806829, 6.807934, 6.809039, 6.810142, 6.811244, 6.812345,
    6.813444, 6.814542, 6.815639, 6.816735, 6.817830, 6.818924, 6.820016,
    6.821107, 6.822197, 6.823286, 6.824373, 6.825460, 6.826545, 6.827629,
    6.828712, 6.829793, 6.830874, 6.831953, 6.833031, 6.834108, 6.835184,
    6.836259, 6.837332, 6.838405, 6.839476, 6.840546, 6.841615, 6.842683,
    6.843749, 6.844815, 6.845879, 6.846943, 6.848005, 6.849066, 6.850126,
    6.851184, 6.852242, 6.853299, 6.854354, 6.855408, 6.856461, 6.857514,
    6.858565, 6.859614, 6.860663, 6.861711, 6.862757, 6.863803, 6.864847,
    6.865891, 6.866933, 6.867974, 6.869014, 6.870053, 6.871091, 6.872128,
    6.873163, 6.874198, 6.875232, 6.876264, 6.877296, 6.878326, 6.879355,
    6.880384, 6.881411, 6.882437, 6.883462, 6.884486, 6.885509, 6.886531,
    6.887552, 6.888572, 6.889591, 6.890609, 6.891625, 6.892641, 6.893656,
    6.894670, 6.895682, 6.896694, 6.897704, 6.898714, 6.899723, 6.900730,
    6.901737, 6.902742, 6.903747, 6.904750, 6.905753, 6.906754, 6.907755,
    6.908754, 6.909753, 6.910750, 6.911747, 6.912742, 6.913737, 6.914730,
    6.915723, 6.916715, 6.917705, 6.918695, 6.919683, 6.920671, 6.921658,
    6.922643, 6.923628, 6.924612, 6.925595, 6.926577, 6.927557, 6.928537,
    6.929516, 6.930494,
};

// Add an ADC sample.
static inline void time_constant_add_to_buffer(const uint16_t sample) {
    g_time_constant_adc_samples[g_time_constant_num_adc_samples] = sample;
    ++g_time_constant_num_adc_samples;
}

// Estimate the minimum ADC sample.
static inline uint16_t time_constant_estimate_min_sample(void) {
    // The minimum sample is the mean of the last few samples.
    uint32_t sum = 0;
    for (size_t i = 0; i < TIME_CONSTANT_NUM_AVERAGES_FOR_MIN_ADC_SAMPLE; ++i) {
        sum += g_time_constant_adc_samples[g_time_constant_num_adc_samples - 1 -
                                           i];
    }
    return sum / TIME_CONSTANT_NUM_AVERAGES_FOR_MIN_ADC_SAMPLE;
}

// Estimate the three tau index.
static inline size_t time_constant_estimate_three_tau_index(void) {
    const uint16_t max_adc_sample = g_time_constant_adc_samples[0];
    const uint16_t min_adc_sample = time_constant_estimate_min_sample();

    // The sample at 3tau corresponds to where the exponential has decayed by
    // 95%.
    const uint16_t three_tau_value =
        0.95 * min_adc_sample + 0.05 * max_adc_sample;
    for (size_t i = 0; i < g_time_constant_num_adc_samples; ++i) {
        if (g_time_constant_adc_samples[i] < three_tau_value) {
            return i;
        }
    }
    return g_time_constant_num_adc_samples;
}

// Return the natural logarithm of the given value.
static inline float time_constant_ln(const uint16_t value) {
    return g_time_constant_ln_lookup_table[value];
}

// Estimate the slope.
static inline float time_constant_estimate_slope(void) {
    const uint16_t min_adc_sample = time_constant_estimate_min_sample();
    const size_t three_tau_index = time_constant_estimate_three_tau_index();
    const uint16_t exponential_scaling_factor =
        g_time_constant_adc_samples[0] - min_adc_sample;

    float numerator = 0;
    float denominator = 0;

    // Approximate mean x-value as tau/2.
    const float x_mean = three_tau_index / 3.0 / 2;
    for (size_t k = 0; k < three_tau_index; ++k) {
        const float weight =
            exponential_scaling_factor * exponential_scaling_factor /
            (TIME_CONSTANT_ADC_STDDEV * TIME_CONSTANT_ADC_STDDEV) *
            exp(-2.0 * 3 * k / three_tau_index);
        numerator +=
            weight * (k - x_mean) *
            time_constant_ln(g_time_constant_adc_samples[k] - min_adc_sample);
        denominator += weight * (k - x_mean) * (k - x_mean);
    }
    return -numerator / denominator;
}

void time_constant_init(void) {
    g_time_constant_num_adc_samples = 0;
    g_time_constant_min_adc_sample = ADC_MAX_THEORETICAL_ADC_SAMPLE;
    g_time_constant_num_samples_since_minimum = 0;
    g_time_constant_state = TIME_CONSTANT_STATE_IDLE;
}

bool time_constant_add_sample(const uint16_t adc_sample) {
    switch (g_time_constant_state) {
        case TIME_CONSTANT_STATE_IDLE: {
            const uint16_t previous_adc_sample =
                g_time_constant_adc_samples[g_time_constant_num_adc_samples];
            if (previous_adc_sample == ADC_MAX_ADC_SAMPLE &&
                adc_sample < ADC_MAX_ADC_SAMPLE) {
                adc_msb_init(adc_sample + ADC_MAX_THEORETICAL_ADC_SAMPLE -
                             ADC_MAX_ADC_SAMPLE);
                const uint16_t disambiguated_adc_sample =
                    adc_msb_get_disambiguated_sample();
                time_constant_add_to_buffer(disambiguated_adc_sample);
                g_time_constant_min_adc_sample = disambiguated_adc_sample;
                g_time_constant_state = TIME_CONSTANT_STATE_RECEIVING;
            } else {
                g_time_constant_adc_samples[g_time_constant_num_adc_samples] =
                    adc_sample;
            }
            break;
        }
        case TIME_CONSTANT_STATE_RECEIVING: {
            adc_msb_disambiguate(adc_sample);
            const uint16_t disambiguated_adc_sample =
                adc_msb_get_disambiguated_sample();
            time_constant_add_to_buffer(disambiguated_adc_sample);

            // Update the minimum ADC sample.
            if (disambiguated_adc_sample < g_time_constant_min_adc_sample) {
                g_time_constant_min_adc_sample = disambiguated_adc_sample;
                g_time_constant_num_samples_since_minimum = 0;
            } else {
                ++g_time_constant_num_samples_since_minimum;

                // If the minimum ADC sample has not been updated for a while,
                // the exponential might have finished decaying.
                if (g_time_constant_num_samples_since_minimum >
                    TIME_CONSTANT_MAX_NUM_SAMPLES_SINCE_MINIMUM) {
                    g_time_constant_state =
                        TIME_CONSTANT_STATE_HAS_SUFFICIENT_SAMPLES;
                }
            }
            break;
        }
        case TIME_CONSTANT_STATE_INVALID:
        case TIME_CONSTANT_STATE_HAS_SUFFICIENT_SAMPLES:
        case TIME_CONSTANT_STATE_DONE:
        default: {
            return false;
        }
    }
    return true;
}

bool time_constant_has_sufficient_samples(void) {
    return g_time_constant_state == TIME_CONSTANT_STATE_HAS_SUFFICIENT_SAMPLES;
}

float time_constant_estimate(void) {
    const float estimated_slope = time_constant_estimate_slope();
    return TIME_CONSTANT_SAMPLING_PERIOD_MS / estimated_slope * 0.001;
}
